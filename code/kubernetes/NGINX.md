[âŒ« back](../KUBERNETES.md)

## Custom NGINX
### 1. Configure nginx deployment

- Add volumes <sup>**a**</sup>
    - configMap
        - Custom nginx configuration
    - secrets
        - keys <sup>**b**</sup>
        - dhparam <sup>**c**</sup>
- **a**
  - Create a Secret/ConfigMap before using it
  - A container using a Secret/ConfigMap as a subPath volume mount will not receive Secret/ConfigMap updates
- **b**
  - Generated by ACME certificate before deployment, see [Cert Manager guide](CERT-MANAGER.md)
- **c**
  - Generate DH parameters with at least 2048 bits. DH parameters should match your TLS certificate. Cert Manager ACME default is 2048-bit RSA. Documentation [here](http://docs.cert-manager.io/en/master/reference/api-docs/index.html#-strong-cert-manager-strong-)
  - Steps:
    1. `$ sudo openssl dhparam -out dhparam.pem 2048`
    2. `$ sudo kubectl create secret generic <secret name> --from-file=dhparam.pem`
    3. Mount to separate directory, `/etc/nginx/dhparam`

```yaml
apiVersion: apps/v1beta2
kind: Deployment
metadata:
  name: nginx
  namespace: default
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 1
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
        volumeMounts:
        - name: nginx-configmap
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: acme-certificate-secret
          mountPath: /etc/nginx/ssl
          readOnly: true
        - name: dhparam-secret
          mountPath: /etc/nginx/dhparam
          readOnly: true
      volumes:
      - name: nginx-configmap
        configMap:
          name: nginx-configmap
      - name: acme-certificate-secret
        secret:
          secretName: acme-certificate-secret
      - name: dhparam-secret
        secret:
          secretName: dhparam-secret
```

</br>

### 2. Configure nginx service (LoadBalancer) for external http and https traffic

 - Reserve static IP
 - Setup DNS for custom domain name (Optional)

```yaml
apiVersion: v1
kind: Service
metadata:
    name: nginx-service
    namespace: default
spec:
  ports: #Target pod ports running NGINX
  - name: http
    protocol: TCP
    port: 80
    targetPort: 80
  - name: https
    protocol: TCP
    port: 443
    targetPort: 443
  selector:
    app: nginx #Direct to podname nginx running NGINX
  type: LoadBalancer #Expose externally
  loadBalancerIP: <IP ADDRESS> #Generated static IP from host
```

</br>

### 3. Configure configMap

  - Add custom nginx configuration

```yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-configmap
  namespace: default
data:
  nginx.conf: |

    <add custom nginx conf here>

```

</br>

### 4. [Test website](https://securityheaders.com)